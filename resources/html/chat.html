<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Interface</title>
    <link href="/css/styles.css" rel="stylesheet">
    <link href="/css/chat.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
</head>
<body>
    <div class="chat-container">
        <div class="settings">
            <select id="modelSelect">
                <option value="">Загрузка моделей...</option>
            </select>
            <input type="password" 
                    class="api-key-input"
                    size="32"
                    placeholder="API Key"
                    id="apiKey">
        </div>
        
        <div class="chat-history" id="chatHistory"></div>
        
        <div class="input-group">
            <input type="text" 
                    id="messageInput" 
                    placeholder="Введите сообщение...">
            <button id="sendButton"><span>Отправить</span></button>
        </div>
    </div>

    <script>
        let chatHistory = [];
        const MAX_HISTORY = 4;

        async function loadModels() {
            try {
                const response = await fetch('/v1/models?chat=true');
                const data = await response.json();
                const select = document.getElementById('modelSelect');
                
                select.innerHTML = data.data
                    .map(m => `<option value="${m.id}">${m.owned_by} » ${m.id}</option>`)
                    .join('');
            } catch (e) {
                console.error('Error loading models:', e);
            }
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const modelSelect = document.getElementById('modelSelect');
            const apiKey = document.getElementById('apiKey').value;
            const message = messageInput.value.trim();
            
            if (!message || !modelSelect.value || !apiKey) return;

            addMessageToUI('user', message);
            
            // Формируем историю сообщений
            const messages = [
                ...chatHistory.slice(-MAX_HISTORY * 2),
                { role: 'user', content: message }
            ];
            
            const btn = document.getElementById('sendButton');
            const originalText = btn.innerHTML;
            
            try {
                btn.classList.add('sending');
                btn.disabled = true;
                messageInput.value = '';

                const response = await fetch('/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelSelect.value,
                        messages: messages,
                        temperature: 0.7
                    })
                });

                // Обработка HTTP ошибок
                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMessage = 'Ошибка сервера';
                    
                    // Обработка специфических ошибок авторизации
                    if (response.status === 401) {
                        errorMessage = errorData.detail || 'Неверный API ключ';
                    }
                    
                    throw new Error(`${errorMessage}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // Добавляем ответ в историю
                addMessageToUI('assistant', content);
                chatHistory.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: content }
                );
            } catch (e) {
                // Специальная обработка сетевых ошибок
                if (e.name === 'TypeError' && e.message === 'Failed to fetch') {
                    addMessageToUI('assistant', 'Ошибка соединения с сервером');
                } else {
                    addMessageToUI('assistant', `Ошибка: ${e.message}`);
                }
            } finally {
                btn.classList.remove('sending');
                btn.disabled = false;
            }
        }
        function addMessageToUI(role, content) {
            const history = document.getElementById('chatHistory');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;
            
            // Рендеринг Markdown с санитизацией
            const cleanHtml = DOMPurify.sanitize(marked.parse(content, {
                breaks: true,
                gfm: true,
                smartypants: true
            }));
            
            messageDiv.innerHTML = cleanHtml;
            history.appendChild(messageDiv);
            history.scrollTop = history.scrollHeight;
        }

        // Инициализация
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        loadModels();
    </script>
</body>
</html>